<form [formGroup]="form" (ngSubmit)="submit()">
  <div class="toolbar">
    <button type="button" class="btn" (click)="addItem()">+ Agregar ítem</button>
    <div class="spacer"></div>
    <strong>Total: Q. {{ total() | number:'1.2-2' }}</strong>
  </div>

  <div class="table-responsive">
  <table class="table">
    <thead>
      <tr>
        <th style="width:48%">Producto</th>
        <th style="width:16%" class="num">Precio</th>
        <th style="width:16%" class="num">Cantidad</th>
        <th style="width:16%" class="num">Subtotal</th>
        <th style="width:4%"></th>
      </tr>
    </thead>
    <tbody formArrayName="items">
      <tr *ngFor="let g of items.controls; let i = index" [formGroupName]="i">
        <td>
          <select formControlName="productId" (change)="onProductChange(i)">
            <option [ngValue]="null" disabled>— Selecciona —</option>
            <option *ngFor="let p of productos" [ngValue]="p.id">{{ p.name }}</option>
          </select>
        </td>
        <td class="num"><input type="number" min="0" step="0.01" formControlName="price" [placeholder]="productById(g.value.productId)?.price"></td>
        <td class="num"><input type="number" min="1" formControlName="quantity"></td>
        <td class="num">Q. {{ lineTotal(i) | number:'1.2-2' }}</td>
        <td><button type="button" class="btn btn-danger" (click)="removeItem(i)">✕</button></td>
      </tr>
    </tbody>
  </table>
  </div>

  <div class="footer">
    <button class="btn btn-primary" type="submit" [disabled]="loading || form.invalid">{{ loading ? 'Guardando…' : 'Registrar venta' }}</button>
  </div>

  <div class="msg ok" *ngIf="success">{{ success }}</div>
  <div class="msg err" *ngIf="error">{{ error }}</div>
</form>
